!function(e){e.fn.collection=function(t){var n={container:"body",allow_up:!0,up:'<a href="#">&#x25B2;</a>',before_up:function(e,t){return!0},after_up:function(e,t){return!0},allow_down:!0,down:'<a href="#">&#x25BC;</a>',before_down:function(e,t){return!0},after_down:function(e,t){return!0},allow_add:!0,add:'<a href="#">[ + ]</a>',before_add:function(e,t){return!0},after_add:function(e,t){return!0},allow_remove:!0,remove:'<a href="#">[ - ]</a>',before_remove:function(e,t){return!0},after_remove:function(e,t){return!0},allow_duplicate:!1,duplicate:'<a href="#">[ # ]</a>',before_duplicate:function(e,t){return!0},after_duplicate:function(e,t){return!0},before_init:function(e){},after_init:function(e){},min:0,max:100,add_at_the_end:!1,prefix:"collection",prototype_name:"__name__",name_prefix:null,elements_selector:"> div",children:null,init_with_n_elements:0,hide_useless_buttons:!0,drag_drop:!0,drag_drop_options:{placeholder:"ui-state-highlight"},drag_drop_start:function(e,t){return!0},drag_drop_update:function(e,t){return!0}},i=function(){var e=""+1e3*Math.random()*(new Date).getTime();return e.replace(".","").split("").sort(function(){return.5-Math.random()}).join("")},r=function(t,n){if(!n.attr("id")){var r;do r=t+"_"+i();while(e("#"+r).length>0);n.attr("id",r)}return n.attr("id")},a=function(t){try{var n=e(t)}catch(e){return null}return 0===n.length?null:n.is('input[type="checkbox"]')?n.prop("checked")===!0:n.is('input[type="radio"]')&&void 0!==n.attr("name")?e('input[name="'+n.attr("name")+'"]:checked').val():void 0!==n.prop("value")?n.val():n.html()},o=function(t,n,i){try{var r=e(t)}catch(e){return}0!==r.length&&(r.is('input[type="checkbox"]')?n?r.attr("checked",!0):r.removeAttr("checked"):void 0!==r.prop("value")?i?r.attr("value",n):r.val(n):r.html(n))},l=function(e){return void 0===e||e},d=function(e){return(e+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")},c=function(t,n,i,r){var a=function(t){var n=e(t);e.each(t.attributes,function(t,a){"string"===e.type(a.value)&&n.attr(a.name.replace(i,r),a.value.replace(i,r))}),e.each(n.data(),function(t,a){"string"===e.type(a)&&n.data(t.replace(i,r),a.replace(i,r))})},o=t.eq(n);a(o[0]),o.find("*").each(function(){a(this)})},f=function(e,t,n,i,r,a){var o=new RegExp(d(n.name_prefix+"["+r+"]"),"g"),l=n.name_prefix+"["+a+"]";c(t,i,o,l),o=new RegExp(d(e.attr("id")+"_"+r),"g"),l=e.attr("id")+"_"+a,c(t,i,o,l)},s=function(e,t,n,i,r){var a=new RegExp(d(t.name_prefix+"["+i+"]"),"g"),o=t.name_prefix+"["+r+"]";return n=n.replace(a,o),a=new RegExp(d(e.attr("id")+"_"+i),"g"),o=e.attr("id")+"_"+r,n=n.replace(a,o)},p=function(t){e(t).find(":input").each(function(e,t){o(t,a(t),!0)})},u=function(e,t,n,i){var r=e.data("collection-settings");return f(e,t,r,n,n,"__swap__"),f(e,t,r,i,i,n),f(e,t,r,n,"__swap__",i),t.eq(n).insertBefore(t.eq(i)),i>n?t.eq(i).insertBefore(t.eq(n)):t.eq(i).insertAfter(t.eq(n)),e.find(r.elements_selector)},_=function(e,t,n,i,r){for(var a=i+1;a<=r;a++)t=u(e,t,a,a-1);return e.find(n.elements_selector)},h=function(e,t,n,i,r){for(var a=i-1;a>=r;a--)t=u(e,t,a,a+1);return e.find(n.elements_selector)},m=function(e,t,n,i){for(var r=i+1;r<t.length;r++)t=u(e,t,r-1,r);return e.find(n.elements_selector)},v=function(e,t,n,i){for(var r=t.length-2;r>i;r--)t=u(e,t,r+1,r);return e.find(n.elements_selector)},x=function(t,n,i){var a=0===t.find("."+n.prefix+"-tmp").length,o=t.find(n.elements_selector);if(n.allow_add&&a&&(t.append('<span class="'+n.prefix+'-tmp"></span>'),n.add&&t.append(e(n.add).addClass(n.prefix+"-action "+n.prefix+"-rescue-add").data("collection",t.attr("id")))),i)for(var l=e(n.container),d=t.find("."+n.prefix+"-add, ."+n.prefix+"-rescue-add, ."+n.prefix+"-duplicate").first();o.length<n.init_with_n_elements;){var c=o.length>0?o.last():void 0,f=o.length+1;o=w(l,d,t,n,o,c,f,!1)}if(o.each(function(i){var a=e(this),l=a.find("."+n.prefix+"-actions").andSelf().filter("."+n.prefix+"-actions");0===l.length&&(l=e('<div class="'+n.prefix+'-actions"></div>'),a.append(l));var d=[{enabled:n.allow_remove,selector:n.prefix+"-remove",html:n.remove,condition:o.length>n.min},{enabled:n.allow_up,selector:n.prefix+"-up",html:n.up,condition:0!==o.index(a)},{enabled:n.allow_down,selector:n.prefix+"-down",html:n.down,condition:o.index(a)!==o.length-1},{enabled:n.allow_add&&!n.add_at_the_end,selector:n.prefix+"-add",html:n.add,condition:o.length<n.max},{enabled:n.allow_duplicate,selector:n.prefix+"-duplicate",html:n.duplicate,condition:o.length<n.max}];e.each(d,function(o,d){if(d.enabled){var c=a.find("."+d.selector);0===c.length&&d.html&&(c=e(d.html).appendTo(l).addClass(d.selector)),d.condition?(c.removeClass(n.prefix+"-action-disabled"),n.hide_useless_buttons&&c.css("display","")):(c.addClass(n.prefix+"-action-disabled"),n.hide_useless_buttons&&c.css("display","none")),c.addClass(n.prefix+"-action").data("collection",t.attr("id")).data(n.prefix+"-element",r(t.attr("id")+"_"+i,a))}else a.find("."+d.selector).css("display","none")})}),n.allow_add){var s=t.find("."+n.prefix+"-rescue-add").css("display",""),p=t.find("."+n.prefix+"-add");!n.add_at_the_end&&p.length>0&&s.css("display","none"),o.length>=n.max&&t.find("."+n.prefix+"-add, ."+n.prefix+"-rescue-add, ."+n.prefix+"-duplicate").css("display","none")}},g=function(t,n,i){i.children&&e.each(i.children,function(e,i){return i.selector?void(null!==n?n.find(i.selector).collection(i):t.find(i.selector).collection(i)):(console.log("jquery.collection.js: given collection "+t.attr("id")+" has children collections, but children's root selector is undefined."),!0)})},w=function(t,n,i,r,a,o,c,f){if(a.length<r.max&&(f&&l(r.before_duplicate(i,o))||l(r.before_add(i,o))))for(var u=i.data("prototype"),_=0;_<r.max;_++){var h=new RegExp(d(r.prototype_name),"g"),x=e(u.replace(h,_)),w=i.find("> ."+r.prefix+"-tmp"),y=w.html(x).find("[id]").first().attr("id");if(w.empty(),0===t.find("#"+y).length){if(f){p(a.eq(c));var b=e("<div/>").append(a.eq(c).clone()).html(),j=s(i,r,b,c,_);x=e("<div/>").html(j).contents(),w.before(x).find(r.prefix+"-actions").remove()}else w.before(x);a=i.find(r.elements_selector);var q=x.find("."+r.prefix+"-add, ."+r.prefix+"-duplicate");if(q.length>0&&q.addClass(r.prefix+"-action").data("collection",i.attr("id")),void 0!==n.data(r.prefix+"-element")){var c=a.index(e("#"+n.data(r.prefix+"-element")));c!==-1&&(a=v(i,a,r,c))}g(i,x,r),(f&&!l(r.after_duplicate(i,x))||!l(r.after_add(i,x)))&&(c!==-1&&(a=m(i,a,r,c+1)),x.remove());break}}return a},y=function(e,t,n,i,r){if(n.length>t.min&&l(t.before_remove(e,i))){n=m(e,n,t,r);var a=n.last(),o=a.clone({withDataAndEvents:!0});a.remove(),l(t.after_remove(e,o))||(e.find("> ."+t.prefix+"-tmp").before(o),n=e.find(t.elements_selector),n=v(e,n,t,r-1))}return n},b=function(e,t,n,i,r){return 0!==r&&l(t.before_up(e,i))&&(n=u(e,n,r,r-1),l(t.after_up(e,i))||(n=u(e,n,r-1,r))),n},j=function(e,t,n,i,r){return r!==n.length-1&&l(t.before_down(e,i))&&(n=u(e,n,r,r+1),l(t.after_down(e,n))||(n=u(e,n,r+1,r))),n},q=e(this);return 0===q.length?(console.log("jquery.collection.js: given collection selector does not exist."),!1):(q.each(function(){var i=e.extend(!0,{},n,t);if(0===e(i.container).length)return console.log("jquery.collection.js: a container should exist to handle events (basically, a <body> tag)."),!1;var r=e(this);if(void 0!==r.data("collection")){var a=e("#"+r.data("collection"));if(0===a.length)return console.log("jquery.collection.js: given collection id does not exist."),!0}else a=r;if(i.before_init(a),null===a.data("prototype"))return console.log("jquery.collection.js: given collection field has no prototype, check that your field has the prototype option set to true."),!0;if(void 0!==a.data("prototype-name")&&(i.prototype_name=a.data("prototype-name")),void 0!==a.data("allow-add")&&(i.allow_add=a.data("allow-add"),i.allow_duplicate=!!a.data("allow-add")&&i.allow_duplicate),void 0!==a.data("allow-remove")&&(i.allow_remove=a.data("allow-remove")),void 0!==a.data("name-prefix")&&(i.name_prefix=a.data("name-prefix")),!i.name_prefix)return console.log("jquery.collection.js: the prefix used in descendant field names is mandatory, you can set it using 2 ways:"),console.log("jquery.collection.js: - use the form theme given with this plugin source"),console.log("jquery.collection.js: - set name_prefix option to  '{{ formView.myCollectionField.vars.full_name }}'"),!0;if(i.init_with_n_elements<i.min&&(i.init_with_n_elements=i.min),i.drag_drop&&i.allow_up&&i.allow_down){var o,d;"undefined"==typeof jQuery.ui||"undefined"==typeof jQuery.ui.sortable?i.drag_drop=!1:a.sortable(e.extend(!0,{},{start:function(t,n){var r=a.find(i.elements_selector),d=n.item,c=e(this);return l(i.drag_drop_start(t,n,r,d))?(n.placeholder.height(n.item.height()),n.placeholder.width(n.item.width()),void(o=r.index(d))):void c.sortable("cancel")},update:function(t,n){var r=a.find(i.elements_selector),c=n.item,f=e(this);f.sortable("cancel"),!1!==i.drag_drop_update(t,n,r,c)&&l(d-o>0?i.before_up(a,c):i.before_down(a,c))&&(d=r.index(c),r=a.find(i.elements_selector),1===Math.abs(d-o)?(r=u(a,r,o,d),l(d-o>0?i.after_up(a,c):i.after_down(a,c))||(r=u(a,r,d,o))):o<d?(r=_(a,r,i,o,d),l(d-o>0?i.after_up(a,c):i.after_down(a,c))||(r=h(a,r,i,d,o))):(r=h(a,r,i,o,d),l(d-o>0?i.after_up(a,c):i.after_down(a,c))||(r=_(a,r,i,d,o))),x(a,i,!1))}},i.drag_drop_options))}a.data("collection-settings",i);var c=e(i.container);c.off("click","."+i.prefix+"-action").on("click","."+i.prefix+"-action",function(t){var n=e(this),i=e("#"+n.data("collection")),r=i.data("collection-settings"),a=i.find(r.elements_selector),o=n.data(r.prefix+"-element")?e("#"+n.data(r.prefix+"-element")):void 0,l=o&&o.length?a.index(o):-1,d=n.is("."+r.prefix+"-duplicate");(n.is("."+r.prefix+"-add")||n.is("."+r.prefix+"-rescue-add")||d)&&r.allow_add&&(a=w(c,n,i,r,a,o,l,d)),n.is("."+r.prefix+"-remove")&&r.allow_remove&&(a=y(i,r,a,o,l)),n.is("."+r.prefix+"-up")&&r.allow_up&&(a=b(i,r,a,o,l)),n.is("."+r.prefix+"-down")&&r.allow_down&&(a=j(i,r,a,o,l)),x(i,r,!1),t.preventDefault()}),x(a,i,!0),g(a,null,i),i.after_init(a)}),!0)}}(jQuery);